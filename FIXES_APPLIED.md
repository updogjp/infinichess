# Fixes Applied - Spawn & Display Issues

## Summary
Fixed multiple issues related to AI spawning, leaderboard display, and player piece spawning in 64x64 mode.

## Issues Fixed

### 1. Too Many AI Pieces in 64x64 Mode
**Problem:** AI system was spawning 8 pieces per player even in 64x64 mode, overwhelming the small board.

**Solution:** 
- Disabled AI completely in 64x64 mode by adding check in `spawnAIPieces()`:
  ```javascript
  if (!GAME_CONFIG.infiniteMode) return;
  ```
- AI now only spawns in infinite mode where there's plenty of space

**File:** `server/index.js` (line ~370)

---

### 2. Leaderboard Display Issues
**Problem:** 
- Weird line appearing below "LEADERBOARD" text
- Display showing colors instead of player names (was actually working, but confusing UX)

**Solution:**
- Removed static leaderboard HTML element that was creating duplicate/conflicting structure
- The leaderboard is now fully dynamically generated by JavaScript
- Removed this from `index.html`:
  ```html
  <div class="lb-group" id="leaderboard-map-Leaderboard">
    <span class="lb-name">LEADERBOARD</span>
    <div class="lb-players"></div>
  </div>
  ```
- The CSS border-bottom on `.lb-name` was causing the line on the static element

**File:** `client/index.html` (removed lines 132-136)

---

### 3. Player Stats Panel Not Showing Name/Color
**Problem:** Stats panel was showing "UNKNOWN" for name and "-" for color.

**Solution:**
- Fixed variable references to use `window.playerName` and `window.playerColor` 
- Updated `client.js` render function to properly read these global variables
- Updated `networking.js` to consistently use `window.playerName` and `window.playerColor` throughout

**Files:** 
- `client/client.js` (lines ~855-857)
- `client/networking.js` (multiple locations where playerName/playerColor are set/used)

---

### 4. Player Pieces Not Spawning in 64x64 Mode
**Problem:** Players' kings weren't appearing when spawning in 64x64 mode, especially when board had many neutral pieces.

**Solution:**
- Enhanced `findSpawnLocation()` with better fallback logic:
  1. Try 100 random locations checking for empty spots near other kings
  2. If that fails in 64x64 mode, exhaustively search the entire board for any empty spot
  3. If board is completely full, force spawn at random location (overwriting if necessary)
- Added extensive logging to track spawn process:
  ```javascript
  console.log(`[SPAWN] Found spawn location at ${x},${y}`);
  console.log(`[SPAWN] Player ${ws.id} spawning king at ${spawn.x},${spawn.y}`);
  ```

**File:** `server/index.js` (lines ~267-305, ~844-869)

---

## Technical Details

### Spawn Location Algorithm (64x64 Mode)
```javascript
// Phase 1: Try 100 random attempts with king buffer check
for (let tries = 0; tries < 100; tries++) {
  // Random location
  // Check if empty
  // Check no kings within 4 squares
  if (valid) return location;
}

// Phase 2: Exhaustive search (64x64 only)
for (let x = 0; x < 64; x++) {
  for (let y = 0; y < 64; y++) {
    if (!spatialHash.has(x, y)) {
      return { x, y };
    }
  }
}

// Phase 3: Force spawn at random location
return randomLocation();
```

### Leaderboard Data Flow
```
Server: sendLeaderboard()
  → Encodes: [magic, onlineCount, ...players[id, kills, nameLen, name]]
  → Broadcasts to all clients

Client: receives msg[0] === 48027
  → Decodes player data with names
  → Dynamically creates lb-group elements
  → Displays with colored indicators
```

---

## Testing Checklist

After these fixes, verify:
- [x] AI pieces don't spawn in 64x64 mode
- [x] AI pieces spawn normally in infinite mode
- [x] Leaderboard displays player names (not colors)
- [x] No weird line under "LEADERBOARD" header
- [x] Stats panel shows correct player name
- [x] Stats panel shows correct player color
- [x] Players can spawn in 64x64 mode even with many neutral pieces
- [x] King pieces appear on board after spawn
- [x] Viewport updates correctly after spawn

---

## Files Modified

1. **server/index.js**
   - Disabled AI in 64x64 mode
   - Enhanced spawn location algorithm with exhaustive fallback
   - Added detailed spawn logging

2. **client/index.html**
   - Removed static leaderboard group element

3. **client/client.js**
   - Fixed playerName/playerColor references with window. prefix

4. **client/networking.js**
   - Fixed all playerName/playerColor references throughout
   - Ensured consistent use of window. prefix

---

## Known Behavior

### AI System (Infinite Mode Only)
- Spawns 8 pieces per online player
- Spawns within 2000 pixel radius of random player
- Removes pieces that wander > 4000 pixels from all players
- Pieces move randomly every 3 seconds with 30% chance

### Spawn System (64x64 Mode)
- Kings must spawn ≥4 squares apart
- Board size: 64x64 (4096 total squares)
- With 253 neutral pieces, ~6% of board is occupied
- Exhaustive search ensures spawn even on crowded boards

---

## Console Output Examples

### Successful Spawn
```
[SPAWN] Found spawn location at 23,45
[SPAWN] Player 12345 spawning king at 23,45
[SPAWN] Updated metadata for player 12345: Alice at 23,45
[SPAWN] Sent viewport state to player 12345
```

### Fallback Spawn
```
[SPAWN] Fallback: searching for any empty spot on 64x64 board
[SPAWN] Fallback found empty spot at 7,12
[SPAWN] Using fallback location 7,12
```

### Leaderboard Update
```
[LEADERBOARD] Broadcasting update for player 12345
[LEADERBOARD] Sending to 3 players: Alice(5), Bob(3), Charlie(1)
```
